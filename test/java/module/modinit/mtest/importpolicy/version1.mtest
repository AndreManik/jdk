#
# Verify that the custom import policy is invoked
# and that it can pick a version of m2 other than the highest
# if no version constraint is specified in the import
#
>>> begin module m1
> annotations
@MainClass("m1.MainA")
@ImportPolicyClass("m1.ImportPolicyImpl")
@ImportModules({
    @ImportModule(name="java.se"),
    @ImportModule(name="m2")
})
> export
m1.Main
>> begin class m1.MainA
        if (ImportPolicyImpl.CALLED == false) {
            throw new Exception("Import policy not called");
        }
        new m2.MainB().run("from m1");
        if (m2.MainB.V != 1) {
            throw new Exception("Wrong version of m2");
        }
>> end class
>> begin class m1.ImportPolicyImpl
> super
implements ImportPolicy
> body
    static volatile boolean CALLED;

    public Map<ImportDependency,VersionConstraint> getImports(ModuleDefinition moduleDef,
            Map<ImportDependency,VersionConstraint> constraints, ImportPolicy defaultImportPolicy)
            throws UnsatisfiedDependencyException {
        CALLED = true;
        Repository rep = moduleDef.getRepository();
        Map<ImportDependency,VersionConstraint> result = new HashMap<ImportDependency,VersionConstraint>();
        for (ImportDependency dep : moduleDef.getImportDependencies()) {
            ModuleDefinition md = rep.find(dep.getName(), dep.getVersionConstraint());
            if (md.getName().equals("m2") == false)
                result.put(dep, md.getVersion().toVersionConstraint());
            else
                result.put(dep, VersionConstraint.valueOf("1.2"));
        }
        return result;
    }
>> end class
>>> end module
>>> begin module m2
> annotations
@Version("1.2")
@ImportModules({
    @ImportModule(name="java.se")
})
> export
m2.MainB
>> begin class m2.MainB
> body
    public static int V = 1;
>> end class
>>> end module
>>> begin module m2
> annotations
@Version("1.5")
@ImportModules({
    @ImportModule(name="java.se")
})
> export
m2.MainB
>> begin class m2.MainB
> body
    public static int V = 2;
>> end class
>>> end module
>>> begin test m1
return
>>> end test
